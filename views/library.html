<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="../styles/style.css" rel="stylesheet">
    <link href="../styles/article_card.css" rel="stylesheet">
    <link href="../styles/header.css" rel="stylesheet">
    <title>Articles</title>
</head>

<body class="tcentered">
    <reusable-header></reusable-header>

    <div class="card-grid">
        <!-- Columns of article cards will be inserted here -->
    </div>


    <reusable-footer></reusable-footer>
</body>

<script src="../components/header.js"></script>
<script type="module" src="../components/footer.js"></script>
<script src="../components/article_card.js"></script>
<script>
    async function loadArticles() {
        try {
            const response = await fetch('../data/posts_metadata.json');
            const articles = await response.json();

            renderGrid(articles); // Use the grid rendering logic
        } catch (error) {
            console.error('Error loading articles:', error);
            const grid = document.querySelector(".card-grid");
            grid.innerHTML = '<p>Sorry, articles could not be loaded at this time.</p>';
        }
    }

    function getColumnCount(articles) {
        const cardWidth = 18 * 16; // 18rem in px
        const gap = 36; // px
        const grid = document.querySelector('.card-grid');
        const style = window.getComputedStyle(grid);
        const paddingLeft = parseInt(style.paddingLeft, 10);
        const paddingRight = parseInt(style.paddingRight, 10);
        const gridWidth = grid.offsetWidth - paddingLeft - paddingRight; // subtract padding

        const maxColumns = Math.floor((gridWidth + gap) / (cardWidth + gap));
        return Math.max(1, Math.min(maxColumns, articles.length));
    }

    function distributeArticles(articles, columns) {
        const result = Array.from({ length: columns }, () => []);
        articles.forEach((article, i) => {
            result[i % columns].push(article);
        });
        return result;
    }

    function renderGrid(articles) {
        const grid = document.querySelector('.card-grid');
        grid.innerHTML = '';
        const columns = getColumnCount(articles);
        const distributed = distributeArticles(articles, columns);

        distributed.forEach(colArticles => {
            const colDiv = document.createElement('div');
            colDiv.className = 'card-column';
            colDiv.style.display = 'flex';
            colDiv.style.flexDirection = 'column';
            colDiv.style.gap = '0px';
            colArticles.forEach(article => {
                const cardHTML = articleCard(
                    article.image,
                    article.title,
                    article.title,
                    article.description,
                    `../views/post.html?id=${article.id}`,
                    "Read More"
                );
                // Add margin-bottom to the column's children via CSS or inline style in articleCard
                colDiv.insertAdjacentHTML('beforeend', cardHTML);
            });
            grid.appendChild(colDiv);
        });
    }

    // Re-render grid on resize
    window.addEventListener('resize', async () => {
        const response = await fetch('../data/posts_metadata.json');
        const articles = await response.json();
        renderGrid(articles);
    });

    // Initial load
    window.addEventListener('DOMContentLoaded', loadArticles);
</script>

</html>